# ウェブアプリケーションのセキュリティ実装 チェックリスト

IPA「安全なウェブサイトの作り方 改訂第7版」準拠

---

## AI操作ガイド

### ステータス記号
- `[ ]` = 未対策（pending）
- `[x]` = 対応済（done）
- `[-]` = 対応不要（n/a）

### 項目フォーマット
```
- [status] `ID` [対策種別] 実施項目
```

### 更新例
```bash
# 項目 1-(i)-a を対応済にする場合
old: - [ ] `1-(i)-a` [根本※] SQL文の組み立ては...
new: - [x] `1-(i)-a` [根本※] SQL文の組み立ては...
```

### 対策種別
- `[根本]` = 根本的解決
- `[根本※]` = 根本的解決（いずれか1つを実施でOK）
- `[保険]` = 保険的対策

---

## チェックリスト

### 1. SQLインジェクション

- [ ] `1-(i)-a` [根本※] SQL文の組み立ては全てプレースホルダで実装する
- [ ] `1-(i)-b` [根本※] SQL文の構成を文字列連結により行う場合は、アプリケーションの変数をSQL文のリテラルとして正しく構成する
- [ ] `1-(ii)` [根本] ウェブアプリケーションに渡されるパラメータにSQL文を直接指定しない
- [ ] `1-(iii)` [保険] エラーメッセージをそのままブラウザに表示しない
- [ ] `1-(iv)` [保険] データベースアカウントに適切な権限を与える

### 2. OSコマンド・インジェクション

- [ ] `2-(i)` [根本] シェルを起動できる言語機能の利用を避ける
- [ ] `2-(ii)` [保険] シェルを起動できる言語機能を利用する場合は、その引数を構成する全ての変数に対してチェックを行い、あらかじめ許可した処理のみを実行する

### 3. パス名パラメータの未チェック／ディレクトリ・トラバーサル

- [ ] `3-(i)-a` [根本※] 外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装を避ける
- [ ] `3-(i)-b` [根本※] ファイルを開く際は、固定のディレクトリを指定し、かつファイル名にディレクトリ名が含まれないようにする
- [ ] `3-(ii)` [保険] ウェブサーバ内のファイルへのアクセス権限の設定を正しく管理する
- [ ] `3-(iii)` [保険] ファイル名のチェックを行う

### 4. セッション管理の不備

- [ ] `4-(i)` [根本] セッションIDを推測が困難なものにする
- [ ] `4-(ii)` [根本] セッションIDをURLパラメータに格納しない
- [ ] `4-(iii)` [根本] HTTPS通信で利用するCookieにはsecure属性を加える
- [ ] `4-(iv)-a` [根本※] ログイン成功後に、新しくセッションを開始する
- [ ] `4-(iv)-b` [根本※] ログイン成功後に、既存のセッションIDとは別に秘密情報を発行し、ページの遷移ごとにその値を確認する
- [ ] `4-(v)` [保険] セッションIDを固定値にしない
- [ ] `4-(vi)` [保険] セッションIDをCookieにセットする場合、有効期限の設定に注意する

### 5. クロスサイト・スクリプティング

#### HTMLテキストの入力を許可しない場合

- [ ] `5-(i)` [根本] ウェブページに出力する全ての要素に対して、エスケープ処理を施す
- [ ] `5-(ii)` [根本] URLを出力するときは、「http://」や「https://」で始まるURLのみを許可する
- [ ] `5-(iii)` [根本] script要素の内容を動的に生成しない
- [ ] `5-(iv)` [根本] スタイルシートを任意のサイトから取り込めるようにしない
- [ ] `5-(v)` [保険] 入力値の内容チェックを行う

#### HTMLテキストの入力を許可する場合

- [ ] `5-(vi)` [根本] 入力されたHTMLテキストから構文解析木を作成し、スクリプトを含まない必要な要素のみを抽出する
- [ ] `5-(vii)` [保険] 入力されたHTMLテキストから、スクリプトに該当する文字列を排除する

#### 全てのウェブアプリケーションに共通

- [ ] `5-(viii)` [根本] HTTPレスポンスヘッダのContent-Typeフィールドに文字コード（charset）の指定を行う
- [ ] `5-(ix)` [保険] 発行するCookieにHttpOnly属性を加え、TRACEメソッドを無効化する
- [ ] `5-(x)` [保険] XSS対策として有効なブラウザ機能を有効にするレスポンスヘッダを返す

### 6. CSRF（クロスサイト・リクエスト・フォージェリ）

- [ ] `6-(i)-a` [根本※] POSTメソッドでアクセスし、hiddenパラメータに秘密情報を挿入、実行ページでその値を検証する
- [ ] `6-(i)-b` [根本※] 処理を実行する直前のページで再度パスワードの入力を求め、正しい場合のみ処理を実行する
- [ ] `6-(i)-c` [根本※] Refererが正しいリンク元かを確認し、正しい場合のみ処理を実行する
- [ ] `6-(ii)` [保険] 重要な操作を行った際に、その旨を登録済みのメールアドレスに自動送信する

### 7. HTTPヘッダ・インジェクション

- [ ] `7-(i)-a` [根本※] ヘッダの出力を直接行わず、ウェブアプリケーションの実行環境や言語に用意されているヘッダ出力用APIを使用する
- [ ] `7-(i)-b` [根本※] 改行コードを適切に処理するヘッダ出力用APIを利用できない場合は、改行を許可しないよう適切な処理を実装する
- [ ] `7-(ii)` [保険] 外部からの入力の全てについて、改行コードを削除する

### 8. メールヘッダ・インジェクション

- [ ] `8-(i)-a` [根本※] メールヘッダを固定値にして、外部からの入力はすべてメール本文に出力する
- [ ] `8-(i)-b` [根本※] ウェブアプリケーションの実行環境や言語に用意されているメール送信用APIを使用する
- [ ] `8-(ii)` [根本] HTMLで宛先を指定しない
- [ ] `8-(iii)` [保険] 外部からの入力の全てについて、改行コードを削除する

### 9. クリックジャッキング

- [ ] `9-(i)-a` [根本※] HTTPレスポンスヘッダに、X-Frame-Optionsヘッダフィールドを出力し、他ドメインのサイトからのframe要素やiframe要素による読み込みを制限する
- [ ] `9-(i)-b` [根本※] 処理を実行する直前のページで再度パスワードの入力を求め、正しい場合のみ処理を実行する
- [ ] `9-(ii)` [保険] 重要な処理は、一連の操作をマウスのみで実行できないようにする

### 10. バッファオーバーフロー

- [ ] `10-(i)-a` [根本※] 直接メモリにアクセスできない言語で記述する
- [ ] `10-(i)-b` [根本※] 直接メモリにアクセスできる言語で記述する部分を最小限にする
- [ ] `10-(ii)` [根本] 脆弱性が修正されたバージョンのライブラリを使用する

### 11. アクセス制御や認可制御の欠落

- [ ] `11-(i)` [根本] アクセス制御機能による防御措置が必要とされるウェブサイトには、パスワード等の秘密情報の入力を必要とする認証機能を設ける
- [ ] `11-(ii)` [根本] 認証機能に加えて認可制御の処理を実装し、ログイン中の利用者が他人になりすましてアクセスできないようにする

---

## サマリー

<!-- AI: 以下のカウントは自動更新してください -->

| 脆弱性 | 対応済 | 未対策 | 対応不要 | 合計 |
|--------|:------:|:------:|:--------:|:----:|
| 1. SQLインジェクション | 0 | 5 | 0 | 5 |
| 2. OSコマンド・インジェクション | 0 | 2 | 0 | 2 |
| 3. ディレクトリ・トラバーサル | 0 | 4 | 0 | 4 |
| 4. セッション管理の不備 | 0 | 7 | 0 | 7 |
| 5. クロスサイト・スクリプティング | 0 | 10 | 0 | 10 |
| 6. CSRF | 0 | 4 | 0 | 4 |
| 7. HTTPヘッダ・インジェクション | 0 | 3 | 0 | 3 |
| 8. メールヘッダ・インジェクション | 0 | 4 | 0 | 4 |
| 9. クリックジャッキング | 0 | 3 | 0 | 3 |
| 10. バッファオーバーフロー | 0 | 3 | 0 | 3 |
| 11. アクセス制御・認可制御の欠落 | 0 | 2 | 0 | 2 |
| **合計** | **0** | **47** | **0** | **47** |

---

## メタデータ

```yaml
last_updated:
updated_by:
review_date:
reviewer:
approval_date:
approver:
```

---

## 参考文献

- [IPA 安全なウェブサイトの作り方 改訂第7版](https://www.ipa.go.jp/security/vuln/websecurity/)
- [IPA チェックリスト PDF](https://www.ipa.go.jp/security/vuln/websecurity/ug65p90000019by6-att/000017319.pdf)
